#!/bin/bash                                                                                                                                                                                                                                                                                                                                                                               
set -e                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                          
echo "üîÑ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ PostgreSQL –∏ Redis..."                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                          
python3 << 'PYTHON_SCRIPT'                                                                                                                                                                                                                                                                                                                                                                
import asyncio                                                                                                                                                                                                                                                                                                                                                                            
import asyncpg                                                                                                                                                                                                                                                                                                                                                                            
import redis.asyncio as aioredis                                                                                                                                                                                                                                                                                                                                                          
import os                                                                                                                                                                                                                                                                                                                                                                                 
import sys                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                          
async def wait_for_services():                                                                                                                                                                                                                                                                                                                                                            
    max_retries = 30                                                                                                                                                                                                                                                                                                                                                                      
    retry_delay = 2                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                          
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ PostgreSQL                                                                                                                                                                                                                                                                                                                                                                 
    for i in range(max_retries):                                                                                                                                                                                                                                                                                                                                                          
        try:                                                                                                                                                                                                                                                                                                                                                                              
            conn = await asyncpg.connect(                                                                                                                                                                                                                                                                                                                                                 
                host=os.getenv('DB_HOST', 'localhost'),                                                                                                                                                                                                                                                                                                                                   
                port=int(os.getenv('DB_PORT', 5432)),                                                                                                                                                                                                                                                                                                                                     
                user=os.getenv('DB_USER', 'teammates_user'),                                                                                                                                                                                                                                                                                                                              
                password=os.getenv('DB_PASSWORD'),                                                                                                                                                                                                                                                                                                                                        
                database=os.getenv('DB_NAME', 'teammates')                                                                                                                                                                                                                                                                                                                                
            )                                                                                                                                                                                                                                                                                                                                                                             
            await conn.close()                                                                                                                                                                                                                                                                                                                                                            
            print("‚úÖ PostgreSQL –≥–æ—Ç–æ–≤!")                                                                                                                                                                                                                                                                                                                                                 
            break                                                                                                                                                                                                                                                                                                                                                                         
        except Exception as e:                                                                                                                                                                                                                                                                                                                                                            
            print(f"‚è≥ PostgreSQL –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–ø–æ–ø—ã—Ç–∫–∞ {i+1}/{max_retries}) - –∂–¥–µ–º...")                                                                                                                                                                                                                                                                                                    
            await asyncio.sleep(retry_delay)                                                                                                                                                                                                                                                                                                                                              
    else:                                                                                                                                                                                                                                                                                                                                                                                 
        print("‚ùå PostgreSQL –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫")                                                                                                                                                                                                                                                                                                                              
        sys.exit(1)                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                          
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ Redis                                                                                                                                                                                                                                                                                                                                                                      
    for i in range(max_retries):                                                                                                                                                                                                                                                                                                                                                          
        try:                                                                                                                                                                                                                                                                                                                                                                              
            redis = aioredis.from_url(                                                                                                                                                                                                                                                                                                                                                    
                f"redis://{os.getenv('REDIS_HOST', 'localhost')}:{os.getenv('REDIS_PORT', 6379)}"                                                                                                                                                                                                                                                                                         
            )                                                                                                                                                                                                                                                                                                                                                                             
            await redis.ping()                                                                                                                                                                                                                                                                                                                                                            
            await redis.close()                                                                                                                                                                                                                                                                                                                                                           
            print("‚úÖ Redis –≥–æ—Ç–æ–≤!")                                                                                                                                                                                                                                                                                                                                                      
            break                                                                                                                                                                                                                                                                                                                                                                         
        except Exception as e:                                                                                                                                                                                                                                                                                                                                                            
            print(f"‚è≥ Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–ø–æ–ø—ã—Ç–∫–∞ {i+1}/{max_retries}) - –∂–¥–µ–º...")                                                                                                                                                                                                                                                                                                         
            await asyncio.sleep(retry_delay)                                                                                                                                                                                                                                                                                                                                              
    else:                                                                                                                                                                                                                                                                                                                                                                                 
        print("‚ùå Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫")                                                                                                                                                                                                                                                                                                                                   
        sys.exit(1)                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                          
asyncio.run(wait_for_services())                                                                                                                                                                                                                                                                                                                                                          
PYTHON_SCRIPT                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                          
echo "üöÄ –ó–∞–ø—É—Å–∫ TeammateBot..."                                                                                                                                                                                                                                                                                                                                                           
exec python main.py                                                                                                                                                                                                                                                                                                                                                                       

